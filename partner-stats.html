<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ | –ü–î–î –®–ø–∞—Ä–≥–∞–ª–∫–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            padding: 30px 0;
        }
        .container {
            max-width: 1200px;
        }
        h1 {
            color: #0a2540;
            font-weight: 800;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(10,37,64,0.05);
        }
        .stat-card h3 {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #0a2540;
        }
        .stat-label {
            color: #ff6b4a;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .partner-badge {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        th {
            background: #0a2540;
            color: white;
            font-weight: 600;
            padding: 15px;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .btn-export {
            background: #0a2540;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .btn-export:hover {
            background: #1a3b5c;
            color: white;
        }
        .amount {
            font-weight: 700;
            color: #0a2540;
        }
        .partner-share {
            color: #ff6b4a;
            font-weight: 700;
        }
        .footer {
            margin-top: 40px;
            color: #6c757d;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã</h1>
        
        <div class="stats-grid" id="stats"></div>
        
        <button class="btn-export" onclick="exportToCSV()">
            ‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CSV
        </button>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–î–æ–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (40%)</th>
                    </tr>
                </thead>
                <tbody id="salesTable"></tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</p>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function loadStats() {
            const sales = JSON.parse(localStorage.getItem('partnerSales') || '[]');
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalSales = sales.length;
            const totalRevenue = sales.reduce((sum, s) => sum + s.price, 0);
            const totalPartnerShare = totalRevenue * 0.4;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º
            const partners = {};
            sales.forEach(sale => {
                if (sale.partner !== 'direct') {
                    if (!partners[sale.partner]) {
                        partners[sale.partner] = {
                            count: 0,
                            revenue: 0
                        };
                    }
                    partners[sale.partner].count++;
                    partners[sale.partner].revenue += sale.price;
                }
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let statsHtml = `
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂</h3>
                    <div class="stat-number">${totalSales}</div>
                    <div class="stat-label">—à—Ç.</div>
                </div>
                <div class="stat-card">
                    <h3>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h3>
                    <div class="stat-number">${totalRevenue} ‚ÇΩ</div>
                    <div class="stat-label">–¥–æ –≤—ã–ø–ª–∞—Ç</div>
                </div>
                <div class="stat-card">
                    <h3>–ü–∞—Ä—Ç–Ω–µ—Ä–∞–º (40%)</h3>
                    <div class="stat-number">${Math.round(totalPartnerShare)} ‚ÇΩ</div>
                    <div class="stat-label">–∫ –≤—ã–ø–ª–∞—Ç–µ</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</h3>
                    <div class="stat-number">${Object.keys(partners).length}</div>
                    <div class="stat-label">—á–µ–ª–æ–≤–µ–∫</div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä—Ç–Ω–µ—Ä—É
            for (let [ref, data] of Object.entries(partners)) {
                statsHtml += `
                    <div class="stat-card">
                        <h3>${ref}</h3>
                        <div class="stat-number">${data.count}</div>
                        <div class="stat-label">–ø—Ä–æ–¥–∞–∂ / ${Math.round(data.revenue * 0.4)} ‚ÇΩ</div>
                    </div>
                `;
            }
            
            document.getElementById('stats').innerHTML = statsHtml;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–¥–∞–∂
            let tableHtml = '';
            sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                const date = new Date(sale.date).toLocaleString('ru-RU');
                const partnerShare = sale.price * 0.4;
                tableHtml += `
                    <tr>
                        <td>${date}</td>
                        <td>
                            <span class="partner-badge">${sale.partner === 'direct' ? '–ü—Ä—è–º–æ–π –∑–∞—Ö–æ–¥' : sale.partner}</span>
                        </td>
                        <td>${sale.product_name || sale.product}</td>
                        <td class="amount">${sale.price} ‚ÇΩ</td>
                        <td class="partner-share">${sale.partner === 'direct' ? '‚Äî' : Math.round(partnerShare) + ' ‚ÇΩ'}</td>
                    </tr>
                `;
            });
            
            if (sales.length === 0) {
                tableHtml = '<tr><td colspan="5" class="text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂</td></tr>';
            }
            
            document.getElementById('salesTable').innerHTML = tableHtml;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportToCSV() {
            const sales = JSON.parse(localStorage.getItem('partnerSales') || '[]');
            
            if (sales.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            let csv = '–î–∞—Ç–∞,–ü–∞—Ä—Ç–Ω–µ—Ä,–¢–æ–≤–∞—Ä,–°—É–º–º–∞,–î–æ–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (40%)\n';
            
            sales.forEach(sale => {
                const date = new Date(sale.date).toLocaleString('ru-RU');
                const partnerShare = sale.price * 0.4;
                csv += `"${date}",${sale.partner},${sale.product_name || sale.product},${sale.price},${sale.partner === 'direct' ? 0 : partnerShare}\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `partner_sales_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadStats();
    </script>
</body>
</html>
